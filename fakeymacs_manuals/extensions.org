#+STARTUP: showall indent

* Fakeymacs extensions manual

** 拡張機能（Extensions）

Fakeymacs には以下の３つの機能拡張を同梱しています。

拡張機能は、個人設定ファイル（config_personal.py）で拡張機能ファイルの読み込みを有効にすることにより、
利用可能となります。

同様の拡張機能ファイルを作成し、個人設定ファイル（config_personal.py）で読み込むことにより、容易に
機能を拡張できます。

*** ■ Emacs の shell-command-on-region の機能をサポートする

Emacs の shell-command-on-region の機能をサポートするための拡張機能です。

**** 拡張機能ファイルの名称

- shell_command_on_region/config.py

**** キーバインド

|---------+-------------------------+-------------|
| Keybind | Function                | Description |
|---------+-------------------------+-------------|
| M-\vert | shell_command_on_region |             |
|---------+-------------------------+-------------|

**** 環境設定

BusyBox もしくは WSL/WSL2 で動作します。

予め、BusyBox もしくは WSL/WSL2 をインストールしてください。

BusyBox は以下のサイトを参考に busybox64.exe を shell_command_on_region の Extention フォルダの
配下に格納してください。

- https://qiita.com/tetsuy/items/22cba0bc2048967b270a

WSL/WSL2 で利用したい場合は、WSL/WSL2 をインストールした後、shell_command_on_region/config.py の
fc.Linux_tool 変数を "WSL" に設定してください。config_personal.py で 本拡張機能ファイルを読み込む前に
変数の設定をすることもできます。

**** 動作仕様

- M-| の押下により shell command を入力するダイヤログが開く（ここにコマンドを入力する）
- リージョンが選択されている場合には、そのリージョンがコマンドの標準入力に投入される
- リージョンが選択されていない場合には、空文字列がコマンドの標準入力に投入される
- コマンドの実行結果はクリップボードに格納される他、最初の10行が Keyhac コンソールに出力される
- さらに C-u M-| のように C-u を前置すると、コマンドの実行結果でリージョンが置き換えられる
- ダイヤログで入力したコマンドはクリップボードリストに登録されるので、再利用可能である

**** 使用例

|-------------------------------+---------------------------------------------------------------------------------------------------|
| Shell command                 | Description                                                                                       |
|-------------------------------+---------------------------------------------------------------------------------------------------|
| M-\vert wc -l                 | リージョンの行数を数え、結果をクリップボードに格納する（Keyhac コンソールにも結果が表示されます） |
| M-\vert grep 'foo'            | リージョンの foo を含む行を抽出し、結果をクリップボードに格納する                                 |
| C-u M-\vert sort              | リージョンをソートした内容で置き換える                                                            |
| C-u M-\vert sed 's/foo/bar/g' | リージョンにある foo を bar に全て置き換える                                                      |
| C-u M-\vert nl -ba            | リージョンに行番号を付ける                                                                        |
| M-\vert sh                    | リージョンの内容をコマンドとしてシェルで実行し、結果をクリップボードに格納する                    |
|-------------------------------+---------------------------------------------------------------------------------------------------|

**** 留意事項

発生するタイミングは分からないのですが、Keyhac コンソールに以下のメッセージが表示されることがあります。
このメッセージの表示後、Keyhac の挙動が不安定になった場合には、「設定のリロード」を行ってください。
対策については、引き続き検討していきます。

#+BEGIN_EXAMPLE
-----------------------------------------
キーフック強制解除を検出しました.
自動的にフックの再設定を行います.

キーフックの強制解除が頻発する場合、時間のかかる処理(300ミリ秒以上)が
メインスレッドで呼び出されていないかを、確認してください.
時間のかかる処理は JobQueue/JobItem を使ってサブスレッドに追い出してください.
-----------------------------------------
#+END_EXAMPLE

*** ■ C-Enter に F2（編集モード移行）を割り当てる

edit_mode_target に指定したアプリケーションソフトで C-Enter に F2（編集モード移行）を割り当てるための
拡張機能です。

**** 拡張機能ファイルの名称

- edit_mode/config.py

**** コンフィグレーションパラメータ

|-------------------------+-----------------------------------------------------------------------------|
| Configuration parameter | Description                                                                 |
|-------------------------+-----------------------------------------------------------------------------|
| edit_mode_target        | C-Enter に F2（編集モード移行）を割り当てるアプリケーションソフトを指定する |
|-------------------------+-----------------------------------------------------------------------------|

**** キーバインド

|---------+---------------------------+-------------|
| Keybind | Function                  | Description |
|---------+---------------------------+-------------|
| C-Enter | self_insert_command("F2") |             |
|---------+---------------------------+-------------|

*** ■ Emacs の場合、IME 切り替え用のキーを C-\ に置き換える

Emacs にフォーカスがあるときに IME 切り替え用のキーを C-\ に置き換えるための拡張機能です。

**** 拡張機能ファイルの名称

- real_emacs/config.py

**** キーバインド

|--------------+---------------------------------+-------------|
| Keybind      | Function                        | Description |
|--------------+---------------------------------+-------------|
| A-`          | keymap.InputKeyCommand("C-Yen") |             |
| <半角／全角> | keymap.InputKeyCommand("C-Yen") |             |
| <無変換>     | keymap.InputKeyCommand("C-F1")  |             |
| <変換>       | keymap.InputKeyCommand("C-F2")  |             |
|--------------+---------------------------------+-------------|

※ Emacs 側での C-F1 と C-F2 の設定については、次のページを参照してください。
- https://w.atwiki.jp/ntemacs/pages/48.html

*** ■ 英語キーボード設定をした OS 上で、日本語キーボードを利用する場合の切り替えを行う

英語キーボード設定をした OS 上で、日本語キーボードを利用する場合の切り替えを行うための拡張機能です。

**** 拡張機能ファイルの名称

- change_keyboard/config.py

**** キーバインド

|-------------+-----------------+-------------|
| Keybind     | Function        | Description |
|-------------+-----------------+-------------|
| C-A-S-Space | change_keyboard |             |
|-------------+-----------------+-------------|
